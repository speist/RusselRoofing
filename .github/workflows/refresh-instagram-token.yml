# Instagram Token Auto-Refresh Workflow
#
# This workflow automatically refreshes the Instagram long-lived access token
# before it expires (60-day validity). Runs weekly at 3:30 AM EST on Sundays.
#
# Required GitHub Secrets:
#   - INSTAGRAM_ACCESS_TOKEN: Current Instagram long-lived access token
#   - VERCEL_TOKEN: Vercel API token (create at https://vercel.com/account/tokens)
#   - VERCEL_PROJECT_ID: Your Vercel project ID (from project settings)
#   - VERCEL_TEAM_ID: Your Vercel team ID (if using team, otherwise optional)
#   - VERCEL_ENV_VAR_ID: The ID of the INSTAGRAM_ACCESS_TOKEN env var in Vercel
#
# Setup Instructions:
# 1. Create Vercel API token at https://vercel.com/account/tokens
# 2. Get Project ID from Vercel Dashboard > Project > Settings > General
# 3. Get Env Var ID via: curl -H "Authorization: Bearer $VERCEL_TOKEN" \
#    "https://api.vercel.com/v9/projects/$PROJECT_ID/env"
# 4. Add all secrets to GitHub repo: Settings > Secrets and variables > Actions

name: Refresh Instagram Token

on:
  schedule:
    # Run every Sunday at 3:30 AM EST (8:30 AM UTC)
    # Cron uses UTC, so 3:30 AM EST = 8:30 AM UTC (or 7:30 AM UTC during DST)
    - cron: '30 8 * * 0'
  workflow_dispatch:
    # Allow manual trigger for testing or emergency refresh
    inputs:
      force_refresh:
        description: 'Force token refresh even if recently refreshed'
        required: false
        default: 'false'
        type: boolean

env:
  # Timezone for logging
  TZ: America/New_York

jobs:
  refresh-token:
    name: Refresh Instagram Token & Redeploy
    runs-on: ubuntu-latest

    steps:
      - name: Display Current Time
        run: |
          echo "Workflow started at: $(date)"
          echo "Timezone: $TZ"

      - name: Refresh Instagram Access Token
        id: refresh
        run: |
          echo "Calling Instagram API to refresh token..."

          RESPONSE=$(curl -s -w "\n%{http_code}" \
            "https://graph.instagram.com/refresh_access_token?grant_type=ig_refresh_token&access_token=${{ secrets.INSTAGRAM_ACCESS_TOKEN }}")

          # Split response body and HTTP status code
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "HTTP Status: $HTTP_CODE"

          if [ "$HTTP_CODE" != "200" ]; then
            echo "::error::Failed to refresh Instagram token. HTTP $HTTP_CODE"
            echo "Response: $BODY"
            exit 1
          fi

          # Extract new token and expiration
          NEW_TOKEN=$(echo "$BODY" | jq -r '.access_token')
          EXPIRES_IN=$(echo "$BODY" | jq -r '.expires_in')

          if [ "$NEW_TOKEN" == "null" ] || [ -z "$NEW_TOKEN" ]; then
            echo "::error::Failed to extract new token from response"
            echo "Response: $BODY"
            exit 1
          fi

          # Calculate expiration date
          EXPIRES_DAYS=$((EXPIRES_IN / 86400))
          EXPIRY_DATE=$(date -d "+${EXPIRES_DAYS} days" '+%Y-%m-%d')

          echo "Token refreshed successfully!"
          echo "New token expires in: $EXPIRES_DAYS days ($EXPIRY_DATE)"

          # Set outputs (token is masked in logs)
          echo "::add-mask::$NEW_TOKEN"
          echo "new_token=$NEW_TOKEN" >> $GITHUB_OUTPUT
          echo "expires_in=$EXPIRES_IN" >> $GITHUB_OUTPUT
          echo "expires_days=$EXPIRES_DAYS" >> $GITHUB_OUTPUT
          echo "expiry_date=$EXPIRY_DATE" >> $GITHUB_OUTPUT

      - name: Update Vercel Environment Variable
        id: update_vercel
        run: |
          echo "Updating INSTAGRAM_ACCESS_TOKEN in Vercel..."

          # Build the API URL
          API_URL="https://api.vercel.com/v9/projects/${{ secrets.VERCEL_PROJECT_ID }}/env/${{ secrets.VERCEL_ENV_VAR_ID }}"

          # Add team ID if provided
          if [ -n "${{ secrets.VERCEL_TEAM_ID }}" ]; then
            API_URL="${API_URL}?teamId=${{ secrets.VERCEL_TEAM_ID }}"
          fi

          # Update the environment variable
          RESPONSE=$(curl -s -w "\n%{http_code}" -X PATCH "$API_URL" \
            -H "Authorization: Bearer ${{ secrets.VERCEL_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"value\": \"${{ steps.refresh.outputs.new_token }}\"}")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "HTTP Status: $HTTP_CODE"

          if [ "$HTTP_CODE" != "200" ]; then
            echo "::error::Failed to update Vercel environment variable. HTTP $HTTP_CODE"
            echo "Response: $BODY"
            exit 1
          fi

          echo "Vercel environment variable updated successfully!"

      - name: Trigger Vercel Redeploy
        id: redeploy
        env:
          DEPLOY_HOOK: ${{ secrets.VERCEL_DEPLOY_HOOK }}
        run: |
          if [ -z "$DEPLOY_HOOK" ]; then
            echo "::notice::No VERCEL_DEPLOY_HOOK configured. Please redeploy manually from Vercel dashboard."
            echo ""
            echo "To create a deploy hook:"
            echo "1. Go to Vercel Dashboard → Project → Settings → Git"
            echo "2. Scroll to 'Deploy Hooks' section"
            echo "3. Create a hook named 'GitHub Actions' for 'main' branch"
            echo "4. Add the URL as VERCEL_DEPLOY_HOOK secret in GitHub"
            exit 0
          fi

          echo "Triggering Vercel redeploy via deploy hook..."

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$DEPLOY_HOOK")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "HTTP Status: $HTTP_CODE"

          if [ "$HTTP_CODE" != "200" ] && [ "$HTTP_CODE" != "201" ]; then
            echo "::warning::Vercel redeploy may have failed. HTTP $HTTP_CODE"
            echo "Response: $BODY"
            echo "Note: The env var was updated. You may need to manually redeploy from Vercel dashboard."
          else
            echo "Vercel redeploy triggered successfully!"
            JOB_ID=$(echo "$BODY" | jq -r '.job.id // "triggered"')
            echo "Job ID: $JOB_ID"
          fi

      - name: Summary
        run: |
          echo "## Instagram Token Refresh Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Refresh Time | $(date) |" >> $GITHUB_STEP_SUMMARY
          echo "| Token Expires | ${{ steps.refresh.outputs.expiry_date }} (${{ steps.refresh.outputs.expires_days }} days) |" >> $GITHUB_STEP_SUMMARY
          echo "| Vercel Env Updated | Yes |" >> $GITHUB_STEP_SUMMARY
          echo "| Deployment Triggered | Check above |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Next scheduled refresh: Next Sunday at 3:30 AM EST" >> $GITHUB_STEP_SUMMARY
